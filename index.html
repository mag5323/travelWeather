<!doctype html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<script src="http://maps.google.com/maps/api/js?sensor=false"></script>	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<!--<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"></script>
	<link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">-->
	<script>
		$(document).ready(function(){			

			var cctvTimer;
			var map;			
			var dirService;
			var dirDisplay;
			var routePolygon;

			init();

			function setCCTViFrame() {
				$.getJSON("cctv.json", function(cctv){
					$.each(cctv, function(index, item){
						var myLatlng = new google.maps.LatLng(item.lat, item.lng);
						var cctvMarker = new google.maps.Marker({
						    position: myLatlng,
						    title: item.lat +","+ item.lng
						});

						cctvMarker.setMap(map);

						google.maps.event.addListener(cctvMarker, 'click', function() {
						    map.setCenter(cctvMarker.getPosition());

						    var infoWindow = new google.maps.InfoWindow({
								content: "<img src='"+item.url+"' width='320px' height='240px' />"
							});

							infoWindow.open(map, cctvMarker);
					    });
					});
				});			
			}

			function setDeviceImg() {
				$.getJSON("device.json", function(device){
		    		$.each(device, function(index, item){
		    			if (item.type == 'CCTV') {
		    				var myLatlng = new google.maps.LatLng(item.wgsy, item.wgsx);
							var deviceMarker = new google.maps.Marker({
							    position: myLatlng,
							    title: item.wgsy +","+ item.wgsx
							});
							deviceMarker.setMap(map);

							google.maps.event.addListener(deviceMarker, 'click', function() {
							    map.setCenter(deviceMarker.getPosition());

							    var infoWindow = new google.maps.InfoWindow({
									content: "<img id='cctvIframe' src='"+item.mobileUrl+"' width='320px' height='240px' onload='refreshMJpeg(this, \""+item.mobileUrl+"\")' />"
								});

								infoWindow.open(map, deviceMarker);
					    	});
		    			}
		    		});
		   	 	});
			}

			/* google map initialize */

			function init() {
				// var deviceLen = position[0].length+1;
				var i;
				var mapOptions = {
					zoom: 8,
					center: new google.maps.LatLng(23.5986813, 121.0173533),
					mapTypeId: google.maps.MapTypeId.ROADMAP
				}
				map = new google.maps.Map(document.getElementById("map"), mapOptions);

				$.getJSON("device.json", function(devices){
					$.each(devices, function(i, device){
	    				var x = device.wgsx;
	    				var y = device.wgsy;
					});
 				});			

 				$.getJSON("cctv.json", function(cctvs){
	    			$.each(cctvs, function(index, cctv){
	    				// i = deviceLen+index;

	    				var x = cctv.lng;
	    				var y = cctv.lat;
	    			});
 				});
			}

			/* route service/display constructing, map target*/

			$("#submit").on("click", function(){
				dirService = new google.maps.DirectionsService();
				dirDisplay = new google.maps.DirectionsRenderer();
				dirDisplay.setMap(map);

				var from = $("#from").val();
				var to = $("#to").val();

				var request = {
					origin: from,
					destination: to,
					travelMode: google.maps.DirectionsTravelMode.DRIVING
				};

				dirService.route(request, function(response, status) {
					if (status == google.maps.DirectionsStatus.OK) {
                        dirDisplay.setDirections(response);
                        var path = response.routes[0].overview_polyline.points;
                        var decodeStr = google.maps.geometry.encoding.decodePath(path);					

						/*$.each(decodeStr, function(index, path){
                        	console.log(path.A +", "+path.k);
                        });*/
                	}
				});				
			});

			$("#cctv").on("click", function(){
	    		setCCTViFrame();
		 	});

		 	$("#device").on("click", function(){
		    	setDeviceImg();
		 	});

		 	$("#clear").on("click", function(){
		 		init();
		 	});
		});		 	
	
		function refreshMJpeg(obj, url){
		    if($("#cctvIframe").length > 0){
		        cctvTimer = setTimeout(function(){
		            obj.src = url + "?t=" + new Date().getTime();
		        },100);
		    }
		}

	</script>

	<style>
		#map {
			height: 700px;
			width: 	1200px;
		}
	</style>
</head>
<body>
	<label for="from">起點</label>
	<input type="text" id="from" value="高雄市小港區" />
	<label for="to">終點</label>
	<input type="text" id="to" value="高雄市楠梓區" />
	<button id="submit">送出</button>
	<hr>

	<button id="cctv">cctv</button>
	<button id="device">device</button>
	<button id="clear">clear</button>
	<hr>

	<div id="map"></div>

	<div id="camera"></div>
</body>
</html>

