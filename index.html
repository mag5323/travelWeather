<!doctype html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<script src="http://maps.google.com/maps/api/js?sensor=false"></script>	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"></script>
	<link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
	<script>
		$(document).ready(function(){			

			var cctvTimer;
			var map;			
			var dirService;
			var dirDisplay;		
			var position = [ 
							[ [],[],[],[],[],[],[],[],[],[] ],
							[ [],[],[],[],[],[],[],[],[] 	] 
						   ];

			init();

			function setCCTViFrame() {
				$.getJSON("cctv.json", function(cctv){
					$.each(cctv, function(index, item){
						if (index == 5){
							return false;
						}
						var img = "<img src='"+item.url+"' width='320px' height='240px' />";
						console.log(item.lng + " , " + item.lat);
						$("#camera").append(img);
					});
				});			
			}

			function setDeviceImg() {
				$.getJSON("device.json", function(device){
		    		$.each(device, function(index, item){
		    			if (index == 5){
							return false;
						}

		    			if (item.type == 'CCTV') {		
		    				var img = "<img id='cctvIframe' src='"+item.mobileUrl+"' width='320px' height='240px' onload='refreshMJpeg(this, \""+item.mobileUrl+"\")' />";
		    				$("#camera").append(img);
		    			}
		    		});
		   	 	});
			}

			/* google map initialize */

			function init() {
				var mapOptions = {
					zoom: 8,
					center: new google.maps.LatLng(23.5986813, 121.0173533),
					mapTypeId: google.maps.MapTypeId.ROADMAP
				}
				map = new google.maps.Map(document.getElementById("map"), mapOptions);

				// @TODO refactor => function LoadJson()
				$.getJSON("device.json", function(devices){
					$.each(devices, function(index, device){

						// @TODO refactor => function setXYScale()
						position[0][index] = device.wgsx.split('').slice(0,10).join('');
	    				position[1][index] = device.wgsy.split('').slice(0,9).join('');
	    				// var x = device.wgsx.split('').slice(0,10);
	    				// var y = device.wgsy.split('').slice(0,9);
	    				// console.log(position[0][index][x[0]][x[1]][x[2]][x[3]][x[4]][x[5]][x[6]][x[7]][x[8]][x[9]]);
	    				console.log(position[0][index]+", "+position[1][index]);
					});
 				});

				var deviceLen = position[0].length+1;
				var i;

				// @TODO refactor => function LoadJson()
 				$.getJSON("cctv.json", function(cctvs){
	    			$.each(cctvs, function(index, cctv){
	    				i = deviceLen+index;

	    				// @TODO refactor => function setXYScale()
	    		// 		position[0][i] = cctv.lng.split('').slice(0,10).join('');
	    		// 		position[1][i] = cctv.lat.split('').slice(0,9).join('');
 						// console.log(position[0][i]+", "+position[1][i]);
	    			});
 				});
			}

			/* route service/display constructing, map target*/

			$("#submit").on("click", function(){
				dirService = new google.maps.DirectionsService();
				dirDisplay = new google.maps.DirectionsRenderer();
				dirDisplay.setMap(map);

				var from = $("#from").val();
				var to = $("#to").val();

				var request = {
					origin: from,
					destination: to,
					travelMode: google.maps.DirectionsTravelMode.DRIVING
				};

				dirService.route(request, function(response, status) {
					if (status == google.maps.DirectionsStatus.OK) {
                        dirDisplay.setDirections(response);
                        var path = response.routes[0].overview_polyline.points;
                        var decodeStr = google.maps.geometry.encoding.decodePath(path);					

						// $.each(decodeStr, function(index, path){
      //                   	// console.log(path.A +", "+path.k);

      //                   });
                	}
				});
			});

			$("#cctv").on("click", function(){
	    		setCCTViFrame();
		 	});

		 	$("#device").on("click", function(){
		    	setDeviceImg();
		 	});

		 	$("#clear").on("click", function(){
		 		$("#camera").empty();
		 	});
		});		 	
	
		function refreshMJpeg(obj, url){
		    if($("#cctvIframe").length > 0){
		        cctvTimer = setTimeout(function(){
		            obj.src = url + "?t=" + new Date().getTime();
		        },100);
		    }
		}

	</script>

	<style>
		#map {
			height: 360px;
			width: 	640px;
		}
	</style>
</head>
<body>
	<label for="from">起點</label>
	<input type="text" id="from" value="高雄市小港區" />
	<label for="to">終點</label>
	<input type="text" id="to" value="高雄市楠梓區" />
	<button id="submit">送出</button>
	<hr>

	<button id="cctv">cctv</button>
	<button id="device">device</button>
	<button id="clear">clear</button>
	<hr>

	<div id="map"></div>

	<div id="camera"></div>
</body>
</html>

